---
name: ProductionBuildDeployment

"on":
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  test:
    name: Build and test (${{ matrix.distro }})
    strategy:
      fail-fast: false
      matrix:
        distro: [debian-12, debian-13, ubuntu-24.04, ubuntu-22.04, macos-14]
        include:
          - distro: debian-12
            os: ubuntu-22.04
            container: debian:12
          - distro: debian-13
            os: ubuntu-22.04
            container: debian:trixie
          - distro: ubuntu-24.04
            os: ubuntu-24.04
          - distro: ubuntu-22.04
            os: ubuntu-22.04
          - distro: macos-14
            os: macos-14
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}
    steps:
      - name: Test HTTP request
        run: |
          curl -sS http://localhost
      - uses: ./.github/actions/build-and-test
        with:
          distro: ${{ matrix.distro }}

  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck
      - name: Run cppcheck
        run: |
          cppcheck --enable=all --std=c++17 \
            --suppress=missingIncludeSystem \
            src
  release:
    needs: [test, lint]
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - name: Create GitHub release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release ${{ github.run_number }}
          draft: true
          prerelease: false
